<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Function 3: Live Feedback</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #444;
      color: #eee;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      margin-top: 20px;
    }
    .video-container {
      margin: 20px auto;
      width: 1080px;
      border: 4px solid #444;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      position: relative;
    }
    img#video-feed {
      width: 1080px;
    }
    /* Countdown timer overlay top right */
    #timer-overlay {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 48px;
      font-weight: bold;
      color: yellow;
      text-shadow: 0 0 10px black;
      display: none;
      user-select: none;
      pointer-events: none;
    }
    /* Toast container bottom center */
    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 18px;
      display: none;
      z-index: 1000;
    }
    /* Buttons inside toast */
    #toast button {
      margin-left: 15px;
      padding: 6px 12px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background-color: #ffe121;
      color: black;
      transition: background-color 0.3s;
    }
    #toast button:hover {
      background-color: #ffcd17ee;
    }
    .button-link {
      display: inline-block;
      text-decoration: none;
      background-color: #ffe121;
      color: black;
      border-radius: 12px;
      transition: background-color 0.3s;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
    }
    .button-link:hover {
      background-color: #ffcd17ee;
    }
    .back-button {
      font-size: 14px;
      padding: 8px 16px;
      position: fixed;
      bottom: 20px;
      left: 20px;
    }
  </style>
  <script>
  // Send signal to server before page unload
  window.addEventListener("beforeunload", function () {
    navigator.sendBeacon("/stop_stream");
  });
  </script>
</head>

<body>
  <img src="/static/SM-Vertical.png" width="240" style="position: absolute; top: 0; left: 0;" />
  <h1>Live Tag Detection</h1>
  <div class="video-container" style="position:relative;">
    <img id="video-feed" src="/video_feed" />
    <div id="timer-overlay"></div>
  </div>

  <div id="toggle-indicator" style="margin: 20px; font-size: 24px;">
    Detection: <span id="toggle-icon" style="color: red;">OFF</span>
  </div>

  <div id="rosbag-control" style="margin: 20px;">
    <button id="rosbag-btn" class="button-link">Start Rosbag Recording</button>
  </div>

  <div id="toast"></div>

  <p style="margin-top: 20px; font-size: 16px;">
    Toggle detection: Press <strong>T</strong><br />
    Clear corners: Press <strong>C</strong><br />
  </p>

  <a id="back-btn" href="/" class="button-link back-button">Back</a>

  <script>
    let detectionOn = false;
    let rosbagRecording = false;

    // Elements
    const toggleIcon = document.getElementById("toggle-icon");
    const timerOverlay = document.getElementById("timer-overlay");
    const toast = document.getElementById("toast");
    const rosbagBtn = document.getElementById("rosbag-btn");
    
    document.getElementById("back-btn").addEventListener("click", function(event) {
        event.preventDefault();
        fetch("/stop_stream", {method: "POST"})
          .then(() => { window.location.href = "/"; });
    });

    // Keyboard toggles for detection etc.
    document.addEventListener("keydown", (event) => {
      if (event.key === "t" || event.key === "T") {
        fetch("/toggle_detection", { method: "POST" })
          .then((response) => {
            if (response.ok) {
              detectionOn = !detectionOn;
              updateToggleIndicator();
            }
          })
          .catch(console.error);
      } else if (event.key === "c" || event.key === "C") {
        fetch("/clear_corners", { method: "POST" });
      } else if (event.key === "f" || event.key === "F") {
        fetch("/toggle_pause", { method: "POST" });
      }
    });

    function updateToggleIndicator() {
      if (detectionOn) {
        toggleIcon.textContent = "ON";
        toggleIcon.style.color = "lime";
      } else {
        toggleIcon.textContent = "OFF";
        toggleIcon.style.color = "red";
      }
    }

    // Toast helper functions
    function showToast(message, buttons = []) {
        toast.innerHTML = "";
        const textNode = document.createElement("span");
        textNode.textContent = message;
        toast.appendChild(textNode);

        buttons.forEach(({ text, onClick }) => {
            const btn = document.createElement("button");
            btn.textContent = text;
            btn.onclick = () => {
            hideToast();
            onClick();
            };
            toast.appendChild(btn);
        });

        toast.style.display = "block";
        toast.style.visibility = "visible";
    }

    function hideToast() {
      toast.style.display = "none";
      toast.style.visibility = "hidden";
      toast.innerHTML = "";
    }

    // Countdown overlay helper
    function showTimerOverlay(seconds) {
      timerOverlay.textContent = seconds;
      timerOverlay.style.display = "block";
    }
    function hideTimerOverlay() {
      timerOverlay.style.display = "none";
    }

    // Handle rosbag button click: step 1 and 2 - prompt user to press Enter
    rosbagBtn.addEventListener("click", () => {
      if (rosbagRecording) {
        alert("Rosbag is already recording.");
        return;
      }

      showToast("Press Enter to start rosbag recording");

      function onEnter(event) {
        if (event.key === "Enter") {
          document.removeEventListener("keydown", onEnter);
          hideToast();
          startCountdownAndRecord();
        }
      }
      document.addEventListener("keydown", onEnter);
    });

    // Start countdown then rosbag recording + detection toggle
    async function startCountdownAndRecord() {
      // 3. 5-second countdown overlay
      for (let i = 5; i >= 1; i--) {
        showTimerOverlay(i);
        await new Promise((r) => setTimeout(r, 800));
      }
      hideTimerOverlay();

      // 4. Make sure detection ON (POST /toggle_detection if off)
      if (!detectionOn) {
        await fetch("/toggle_detection", { method: "POST" });
        detectionOn = true;
        updateToggleIndicator();
      }

      // Start rosbag recording (POST /start_rosbag_record)
      let utcName = "";
      const response = await fetch("/start_rosbag_record", { method: "POST" });
      if (response.ok) {
        const data = await response.json();
        utcName = data.utc_datetime || "";
      }
      rosbagRecording = true;

      // Show 120s timer overlay
      for (let i = 120; i >= 1; i--) {
        showTimerOverlay(i);
        await new Promise((r) => setTimeout(r, 975));
      }
      hideTimerOverlay();

      if (detectionOn) {
        await fetch("/toggle_detection", { method: "POST" });
        detectionOn = false;
        updateToggleIndicator();
      }

      // Pause stream (if you have an endpoint for that)
      await fetch("/toggle_pause", { method: "POST" });

      // 5. Toast prompt to save or remove rosbag
      showToast(`Save rosbag: ${utcName}?`, [
        {
          text: "Yes",
          onClick: async () => {
            rosbagRecording = false;
            await fetch("/toggle_pause", { method: "POST" });
            await fetch("/clear_corners", { method: "POST" });
            hideToast();
          },
        },
        {
          text: "No",
          onClick: async () => {
            rosbagRecording = false;
            await fetch("/remove_rosbag", { method: "POST" });
            await fetch("/toggle_pause", { method: "POST" });
            await fetch("/clear_corners", { method: "POST" });
            hideToast();
          },
        },
      ]);
    }

    // Initialize toggle indicator UI
    updateToggleIndicator();
  </script>
</body>
</html>