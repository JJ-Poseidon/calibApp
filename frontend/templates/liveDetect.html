<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Function 3: Live Feedback</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #444;
            color: #eee;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        h1 {
            margin-top: 20px;
        }
        .video-container {
            margin: 20px auto;
            width: 1080px;
            border: 4px solid #444;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        /* General button styling */
        .button-link {
            display: inline-block;
            text-decoration: none;
            background-color: #ffe121;
            color: black;
            border-radius: 12px;
            transition: background-color 0.3s;
        }

        .button-link:hover {
            background-color: #ffcd17ee;
        }

        /* Back button specific styling */
        .back-button {
            font-size: 14px;
            padding: 8px 16px;
            position: fixed;
            bottom: 20px;
            left: 20px;
        }
    </style>
    <script>
        let detectionOn = false;  // Local state tracking

        document.addEventListener("keydown", function(event) {
            if (event.key === "t" || event.key === "T") {
                fetch("/toggle_detection", { method: "POST" })
                    .then(response => {
                        if (response.ok) {
                            // Toggle local state
                            detectionOn = !detectionOn;
                            updateToggleIndicator();
                        }
                    })
                    .catch(console.error);
            } else if (event.key === "c" || event.key === "C") {
                fetch("/clear_corners", { method: "POST" });
            }
        });

        // Update the on/off indicator
        function updateToggleIndicator() {
            const icon = document.getElementById("toggle-icon");
            if (detectionOn) {
                icon.textContent = "ON";
                icon.style.color = "lime";
            } else {
                icon.textContent = "OFF";
                icon.style.color = "red";
            }
        }

        // Send signal to server before page unload
        window.addEventListener("beforeunload", function () {
            navigator.sendBeacon("/stop_stream");
        });
    </script>
</head>

<body>
    <img src="/static/SM-Vertical.png" width="240" style="position: absolute; top: 0; left: 0;" />
    <h1>Live Tag Detection</h1>
    <div>
        <img src="/video_feed" width="1080" />
    </div>

    <div id="toggle-indicator" style="margin: 20px; font-size: 24px;">
    Detection: <span id="toggle-icon" style="color: red;">OFF</span>
    </div>

    <p style="margin-top: 20px; font-size: 16px;">
        Toggle detection: Press <strong>T</strong><br>
        Clear corners: Press <strong>C</strong><br>
    </p>
    
    <a href="/" class="button-link back-button">Back</a>
</body>
</html>
